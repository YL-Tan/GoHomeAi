# TODO:
#	1.	For Go and Node steps, chain them after the bootstrap—each language toolchain is independent.
name: CI

on:
  push:
    branches: [ main, feature/** ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ────────────────────────────────────────────────────────────────
      # Caches
      # ────────────────────────────────────────────────────────────────
      - name: Cache pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: ${{ runner.os }}-precommit-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Cache Micromamba packages & env
        id: mamba-cache
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/mamba
          key: ${{ runner.os }}-mamba-${{ hashFiles('environment.lock.yml') }}

      # ────────────────────────────────────────────────────────────────
      # Bootstrap env (creates or updates from environment.yml and
      # regenerates environment.lock.yml)
      # ────────────────────────────────────────────────────────────────
      - name: Bootstrap Python env
        env:
          MAMBA_ROOT_PREFIX: ${{ runner.temp }}/mamba
        run: bash ./scripts/bootstrap.sh

      - name: Run tests
        env:
          MAMBA_ROOT_PREFIX: ${{ runner.temp }}/mamba      
        run: micromamba run -n gohomeai pytest -q ml/tests